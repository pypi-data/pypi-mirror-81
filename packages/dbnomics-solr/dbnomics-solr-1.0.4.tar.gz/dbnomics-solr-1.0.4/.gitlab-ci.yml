stages:
  - test
  - publish
  - index

Solr indexation:
  stage: index
  tags:
    - solr-indexation
  image: python:3.8
  except:
    - pushes
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    # PROVIDER_SLUG: Will be defined by each fetcher via the webhook.
    BARE_REPO_FALLBACK: "1"
    FULL: "0"
    JSON_DATA_BASE_DIR: /json-data
    SOLR_URL: https://dbnomics-solr:${SOLR_BASIC_AUTH_PASSWORD}@solr.db.nomics.world/solr/dbnomics
  cache:
    paths:
      - .cache/pip
      - venv/
  before_script:
    - python -m venv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
    - pip install -e .
  script:
    - if [ -z $PROVIDER_SLUG ]; then exit -1; fi
    # Do not change the message below, as it is parsed by dbnomics-dashboard.
    - echo "Indexing provider $PROVIDER_SLUG in Solr..."
    - bash -x clone-or-update-storage.sh $JSON_DATA_BASE_DIR $PROVIDER_SLUG
    - time dbnomics-solr index-provider ${JSON_DATA_BASE_DIR}/${PROVIDER_SLUG}-json-data

Check code quality:
  stage: test
  only:
    - pushes
  image: python:3.8
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    paths:
      - .cache/pip
      - venv/
  before_script:
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -e .[dev]
  script:
    - flake8 .

Publish Docker image:
  stage: publish
  only:
    - tags
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_TAG --destination $CI_REGISTRY_IMAGE:latest

Publish on PyPI:
  stage: publish
  image: python:3.8
  only:
    - tags
  variables:
    # See also: https://git.nomics.world/dbnomics/dbnomics-solr/-/settings/ci_cd
    # TWINE_USERNAME: # defined in project CI settings
    # TWINE_PASSWORD: # defined in project CI settings (secret)
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    paths:
      - .cache/pip
      - venv/
  before_script:
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install twine
  script:
    - python setup.py sdist bdist_wheel
    - twine upload dist/*
  environment:
    name: PyPI
    url: https://pypi.org/project/dbnomics-solr/$CI_COMMIT_TAG

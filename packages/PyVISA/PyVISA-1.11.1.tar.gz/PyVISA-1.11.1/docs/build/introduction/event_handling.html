

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Event handling &mdash; PyVISA 1.10.2.dev153+g04842c3.d20200729 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Resources" href="resources.html" />
    <link rel="prev" title="Reading and Writing values" href="rvalues.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PyVISA
          

          
          </a>

          
            
            
              <div class="version">
                1.10.2.dev153+g04842c3.d20200729
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuring.html">Configuring the backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="communication.html">Communicating with your instrument</a></li>
<li class="toctree-l2"><a class="reference internal" href="example.html">A more complex example</a></li>
<li class="toctree-l2"><a class="reference internal" href="rvalues.html">Reading and Writing values</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Event handling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#waiting-on-events-using-a-queue">Waiting on events using a queue</a></li>
<li class="toctree-l3"><a class="reference internal" href="#registering-handlers-for-event">Registering handlers for event</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="resources.html">Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="shell.html">PyVISA Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="names.html">VISA resource names</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/index.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PyVISA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">User guide</a> &raquo;</li>
        
      <li>Event handling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/introduction/event_handling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="event-handling">
<span id="intro-event-handling"></span><h1>Event handling<a class="headerlink" href="#event-handling" title="Permalink to this headline">¶</a></h1>
<p>VISA supports generating events on the instrument side usually when a register
change and handling then on the controller using two different mechanisms:
- storing the events in a queue
- calling a dedicated handler function registered for that purpose when the
event occurs</p>
<p>PyVISA supports using both mechanism and tries to provide a convenient interface
to both. Below we give a couple of example of how to use each mechanism (using
a fictional instrument).</p>
<div class="section" id="waiting-on-events-using-a-queue">
<h2>Waiting on events using a queue<a class="headerlink" href="#waiting-on-events-using-a-queue" title="Permalink to this headline">¶</a></h2>
<p>First let’s have a look at how to wait for an event to occur which will be stored
in a queue.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyvisa</span> <span class="kn">import</span> <span class="n">ResourceManager</span><span class="p">,</span> <span class="n">constants</span>

<span class="n">rm</span> <span class="o">=</span> <span class="n">ResourceManager</span>

<span class="k">with</span> <span class="n">rm</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s2">&quot;TCPIP::192.168.0.2::INSTR&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">instr</span><span class="p">:</span>

    <span class="c1"># Type of event we want to be notified about</span>
    <span class="n">event_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventType</span><span class="o">.</span><span class="n">service_request</span>
    <span class="c1"># Mechanism by which we want to be notified</span>
    <span class="n">event_mech</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventMechanism</span><span class="o">.</span><span class="n">queue</span>

    <span class="n">instr</span><span class="o">.</span><span class="n">enable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">)</span>

    <span class="c1"># Instrument specific code to enable service request</span>
    <span class="c1"># (for example on operation complete OPC)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*SRE 1&quot;</span><span class="p">)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;INIT&quot;</span><span class="p">)</span>

    <span class="c1"># Wait for the event to occur</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">wait_on_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">event_type</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">timed_out</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">disable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s examine the code. First, to avoid repeating ourselves, we store the type
of event we want to be notified about and the mechanism we want to use to be notified.
And we enable event notifications.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Type of event we want to be notified about</span>
<span class="n">event_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventType</span><span class="o">.</span><span class="n">service_request</span>
<span class="c1"># Mechanism by which we want to be notified</span>
<span class="n">event_mech</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventMechanism</span><span class="o">.</span><span class="n">queue</span>

<span class="n">instr</span><span class="o">.</span><span class="n">enable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we need to setup our instrument to generate the kind of event at the right
time and start the operation that will lead to the event. For the sake of that
example we are going to consider a Service Request event. Usually service request
can be enabled for a range of register state, the details depending on the
instrument. One useful case is to generate a service request when an operation
is complete which is we are pretending to do here.</p>
<p>Finally we wait for the event to occur and we specify a timeout of 1000ms to
avoid waiting for ever. Once we received the event we disable event handling.</p>
</div>
<div class="section" id="registering-handlers-for-event">
<h2>Registering handlers for event<a class="headerlink" href="#registering-handlers-for-event" title="Permalink to this headline">¶</a></h2>
<p>Rather than waiting for an event, it can sometimes be convenient to take immediate
action when an event occurs, in which having the VISA library call directly a function
can be useful. Let see how.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One can enable event handling using both mechanisms (constants.EventMechanism.all)</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">pyvisa</span> <span class="kn">import</span> <span class="n">ResourceManager</span><span class="p">,</span> <span class="n">constants</span>

<span class="n">rm</span> <span class="o">=</span> <span class="n">ResourceManager</span>

<span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">user_handle</span><span class="p">):</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handled event </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">rm</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s2">&quot;TCPIP::192.168.0.2::INSTR&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">instr</span><span class="p">:</span>

    <span class="n">instr</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Type of event we want to be notified about</span>
    <span class="n">event_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventType</span><span class="o">.</span><span class="n">service_request</span>
    <span class="c1"># Mechanism by which we want to be notified</span>
    <span class="n">event_mech</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EventMechanism</span><span class="o">.</span><span class="n">queue</span>

    <span class="n">wrapped</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">wrap_handler</span><span class="p">(</span><span class="n">handle_event</span><span class="p">)</span>

    <span class="n">user_handle</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">install_handler</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">enable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Instrument specific code to enable service request</span>
    <span class="c1"># (for example on operation complete OPC)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;*SRE 1&quot;</span><span class="p">)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;INIT&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">instr</span><span class="o">.</span><span class="n">called</span><span class="p">:</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">instr</span><span class="o">.</span><span class="n">disable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">uninstall_handler</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="n">user_handle</span><span class="p">)</span>
</pre></div>
</div>
<p>Our handler function needs to have a specific signature to be used by VISA. The
expected signature is (session, event_type, event_context, user_handle). This
signature is not exactly convenient since it forces us to deal with a number of
low-level details such session (ID of a resource in VISA) and event_context that
serves the same purpose for events. One way to get a nicer interface is to wrap
the handler using the <a class="reference internal" href="../api/resources.html#pyvisa.resources.Resource.wrap_handler" title="pyvisa.resources.Resource.wrap_handler"><code class="xref py py-attr docutils literal notranslate"><span class="pre">wrap_handler</span></code></a> method of the <a class="reference internal" href="../api/resources.html#pyvisa.resources.Resource" title="pyvisa.resources.Resource"><code class="xref py py-class docutils literal notranslate"><span class="pre">Resource</span></code></a> object. The wrapped
function is expected to have the following signature: (resource, event, user_handle)
which the signature of our handler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">user_handle</span><span class="p">):</span>
    <span class="n">resource</span><span class="o">.</span><span class="n">called</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handled event </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>And before installing the handler, we wrap it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wrapped</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">wrap_handler</span><span class="p">(</span><span class="n">handle_event</span><span class="p">)</span>
</pre></div>
</div>
<p>When wrapping a handler, you need to use the resource on which it is going to be
installed to wrap it. Furthermore note that in order to uninstall a handler you
need to keep the wrapped version around.</p>
<p>Next we install the handler and enable the event processing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">user_handle</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">install_handler</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">instr</span><span class="o">.</span><span class="n">enable_event</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">event_mech</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>When installing a handler one can optionally, specify a user handle that will be
passed to the handler. This handle can be used to identify which handler is called
when registering the same handler multiple times on the same resource. That value
may have to be converted by the backend. As a consequence the value passed to
the handler may not the same as the value registered and its value will be to
the backend dependent. For this reason you need to keep the converted value
returned by install handler to uninstall the handler at a later time.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the case of ctwrapper that ships with PyVISA, the value is converted
to an equivalent ctypes object (c_float for a float, c_int for an integer, etc)</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="resources.html" class="btn btn-neutral float-right" title="Resources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="rvalues.html" class="btn btn-neutral float-left" title="Reading and Writing values" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, PyVISA Authors

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
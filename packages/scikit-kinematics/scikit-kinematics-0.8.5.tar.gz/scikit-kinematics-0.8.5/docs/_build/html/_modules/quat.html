
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>quat &#8212; skinematics 0.8.0 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/skinematics.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skinematics 0.8.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for quat</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Functions for working with quaternions. Note that all the functions also</span>
<span class="sd">work on arrays, and can deal with full quaternions as well as with</span>
<span class="sd">quaternion vectors.</span>

<span class="sd">A &quot;Quaternion&quot; class is defined, with</span>

<span class="sd">- operator overloading for mult, div, and inv.</span>
<span class="sd">- indexing</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">author: Thomas Haslwanter</span>
<span class="sd">date:   Feb-2018</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>

<span class="c1"># The following construct is required since I want to run the module as a script</span>
<span class="c1"># inside the skinematics-directory</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="k">if</span> <span class="n">file_dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">file_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">vector</span><span class="o">,</span> <span class="nn">rotmat</span>

<span class="c1">#import deprecation</span>
<span class="c1">#import warnings</span>
<span class="c1">#warnings.simplefilter(&#39;always&#39;, DeprecationWarning)</span>

<span class="n">pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

<div class="viewcode-block" id="Quaternion"><a class="viewcode-back" href="../quat.html#quat.Quaternion">[docs]</a><span class="k">class</span> <span class="nc">Quaternion</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Quaternion class, with multiplication, division, and inversion.</span>
<span class="sd">    A Quaternion can be created from vectors, rotation matrices,</span>
<span class="sd">    or from Fick-angles, Helmholtz-angles, or Euler angles (in deg).</span>
<span class="sd">    It provides</span>
<span class="sd">    </span>
<span class="sd">    * operator overloading for mult, div, and inv.</span>
<span class="sd">    * indexing</span>
<span class="sd">    * access to the data, in the attribute *values*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inData : ndarray</span>
<span class="sd">             Contains the data in one of the following formats:</span>
<span class="sd">             </span>
<span class="sd">             * vector : (3 x n) or (4 x n) array, containing the quaternion values</span>
<span class="sd">             * rotmat : array, shape (3,3) or (N,9)</span>
<span class="sd">                        single rotation matrix, or matrix with rotation-matrix elements.</span>
<span class="sd">             * Fick : (3 x n) array, containing (psi, phi, theta) rotations about</span>
<span class="sd">                                the (1,2,3) axes [deg] (Fick sequence)</span>
<span class="sd">             * Helmholtz : (3 x n) array, containing (psi, phi, theta) rotations about</span>
<span class="sd">                                the (1,2,3) axes [deg] (Helmholtz sequence)</span>
<span class="sd">             * Euler : (3 x n) array, containing (alpha, beta, gamma) rotations about</span>
<span class="sd">                                the (3,1,3) axes [deg] (Euler sequence)</span>
<span class="sd">    inType : string</span>
<span class="sd">           Specifies the type of the input and has to have one of the following values</span>
<span class="sd">           &#39;vector&#39;[Default], &#39;rotmat&#39;, &#39;Fick&#39;, &#39;Helmholtz&#39;, &#39;Euler&#39;</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    values : (4 x n) array</span>
<span class="sd">        quaternion values</span>
<span class="sd">             </span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    </span>
<span class="sd">    inv()</span>
<span class="sd">        Inverse of the quaterion</span>
<span class="sd">    export(to=&#39;rotmat&#39;)</span>
<span class="sd">        Export to one of the following formats: &#39;rotmat&#39;, &#39;Euler&#39;, &#39;Fick&#39;, &#39;Helmholtz&#39;</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    .. math::</span>
<span class="sd">          \\vec {q}_{Euler}  = \\left[ {\\begin{array}{*{20}{c}}</span>
<span class="sd">          {\\cos \\frac{\\alpha }{2}*\\cos \\frac{\\beta }{2}*\\cos \\frac{\\gamma }{2} - \\sin \\frac{\\alpha }{2}\\cos \\frac{\\beta }{2}\\sin \\frac{\\gamma }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\alpha }{2}*\\sin \\frac{\\beta }{2}*\\cos \\frac{\\gamma }{2} + \\sin \\frac{\\alpha }{2}\\sin \\frac{\\beta }{2}\\sin \\frac{\\gamma }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\alpha }{2}*\\sin \\frac{\\beta }{2}*\\sin \\frac{\\gamma }{2} - \\sin \\frac{\\alpha }{2}\\sin \\frac{\\beta }{2}\\cos \\frac{\\gamma }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\alpha }{2}*\\cos \\frac{\\beta }{2}*\\sin \\frac{\\gamma }{2} + \\sin \\frac{\\alpha }{2}\\cos \\frac{\\beta }{2}\\cos \\frac{\\gamma }{2}} </span>
<span class="sd">        \\end{array}} \\right]</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">          \\vec {q}_{Fick}  = \\left[ {\\begin{array}{*{20}{c}}</span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} + \\sin \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\sin \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} - \\cos \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\sin \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} + \\sin \\frac{\\psi }{2}\\cos \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\sin \\frac{\\theta }{2} - \\sin \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\cos \\frac{\\theta }{2}} </span>
<span class="sd">        \\end{array}} \\right]</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">          \\vec {q}_{Helmholtz}  = \\left[ {\\begin{array}{*{20}{c}}</span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} - \\sin \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\sin \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} + \\cos \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\sin \\frac{\\phi }{2}*\\cos \\frac{\\theta }{2} + \\sin \\frac{\\psi }{2}\\cos \\frac{\\phi }{2}\\sin \\frac{\\theta }{2}} \\\\ </span>
<span class="sd">          {\\cos \\frac{\\psi }{2}*\\cos \\frac{\\phi }{2}*\\sin \\frac{\\theta }{2} - \\sin \\frac{\\psi }{2}\\sin \\frac{\\phi }{2}\\cos \\frac{\\theta }{2}} </span>
<span class="sd">        \\end{array}} \\right]</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; q = Quaternion(array([[0,0,0.1],</span>
<span class="sd">                              [0,0,0.2],</span>
<span class="sd">                              [0,0,0.5]]))</span>
<span class="sd">    &gt;&gt;&gt; p = Quaternion(array([0,0,0.2]))</span>
<span class="sd">    &gt;&gt;&gt; fick = Quaternion( array([[0,0,10],</span>
<span class="sd">                                  [0,10,10]]), &#39;Fick&#39;)</span>
<span class="sd">    &gt;&gt;&gt; combined = p * q</span>
<span class="sd">    &gt;&gt;&gt; divided = q / p</span>
<span class="sd">    &gt;&gt;&gt; extracted = q[1:2]</span>
<span class="sd">    &gt;&gt;&gt; len(q)</span>
<span class="sd">    &gt;&gt;&gt; data = q.values</span>
<span class="sd">    &gt;&gt;&gt; 2</span>
<span class="sd">    &gt;&gt;&gt; inv(q)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inData</span><span class="p">,</span> <span class="n">inType</span><span class="o">=</span><span class="s1">&#39;vector&#39;</span><span class="p">):</span>    
        <span class="sd">&#39;&#39;&#39;Initialization&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">inType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;vector&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inData</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inData</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">inData</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inData</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">inData</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Quaternions can only be based on ndarray or Quaternions!&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">inType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotmat&#39;</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;Conversion from rotation matrices to quaternions.&#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">rotmat2quat</span><span class="p">(</span><span class="n">inData</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">inType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;euler&#39;</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Conversion from Euler angles to quaternions.</span>
<span class="sd">            (a,b,g) stands for (alpha, beta, gamma) &#39;&#39;&#39;</span>
            
            <span class="n">inData</span><span class="p">[</span><span class="n">inData</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="n">inData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">inData</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">cg</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">sg</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">ca</span><span class="o">*</span><span class="n">cb</span><span class="o">*</span><span class="n">cg</span> <span class="o">-</span> <span class="n">sa</span><span class="o">*</span><span class="n">cb</span><span class="o">*</span><span class="n">sg</span><span class="p">,</span>
                                      <span class="n">ca</span><span class="o">*</span><span class="n">sb</span><span class="o">*</span><span class="n">cg</span> <span class="o">+</span> <span class="n">sa</span><span class="o">*</span><span class="n">sb</span><span class="o">*</span><span class="n">sg</span><span class="p">,</span>
                                      <span class="n">ca</span><span class="o">*</span><span class="n">sb</span><span class="o">*</span><span class="n">sg</span> <span class="o">-</span> <span class="n">sa</span><span class="o">*</span><span class="n">sb</span><span class="o">*</span><span class="n">cg</span><span class="p">,</span>
                                      <span class="n">ca</span><span class="o">*</span><span class="n">cb</span><span class="o">*</span><span class="n">sg</span> <span class="o">+</span> <span class="n">sa</span><span class="o">*</span><span class="n">cb</span><span class="o">*</span><span class="n">cg</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">inType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fick&#39;</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Conversion from Fick angles to quaternions.</span>
<span class="sd">            (p,f,t) stands for (psi, phi, theta) &#39;&#39;&#39;</span>
            
            <span class="n">inData</span><span class="p">[</span><span class="n">inData</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="n">inData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">inData</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">ct</span> <span class="o">+</span> <span class="n">sp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">sp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">ct</span> <span class="o">-</span> <span class="n">cp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">cp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">ct</span> <span class="o">+</span> <span class="n">sp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">cp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">st</span> <span class="o">-</span> <span class="n">sp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">ct</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            
        <span class="k">elif</span> <span class="n">inType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;helmholtz&#39;</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39; Conversion from Helmholtz angles to quaternions.</span>
<span class="sd">            (p,f,t) stands for (psi, phi, theta) &#39;&#39;&#39;</span>
            
            <span class="n">inData</span><span class="p">[</span><span class="n">inData</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">360</span>
            <span class="n">inData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">inData</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="n">ct</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">inData</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span> <span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">ct</span> <span class="o">-</span> <span class="n">sp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">sp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">ct</span> <span class="o">+</span> <span class="n">cp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">cp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">ct</span> <span class="o">+</span> <span class="n">sp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">st</span><span class="p">,</span>
                                      <span class="n">cp</span><span class="o">*</span><span class="n">cf</span><span class="o">*</span><span class="n">st</span> <span class="o">-</span> <span class="n">sp</span><span class="o">*</span><span class="n">sf</span><span class="o">*</span><span class="n">ct</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The &quot;length&quot; is given by the number of quaternions.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Operator overloading for multiplication.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">q_mult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Operator overloading for division.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">q_mult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">q_inv</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Operator overloading for division.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">q_mult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">q_inv</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">select</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">select</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        
    <span class="c1">#def __delitem__(self, select):</span>
        <span class="c1">#np.delete(self.values, select, axis=0)</span>
        
<div class="viewcode-block" id="Quaternion.inv"><a class="viewcode-back" href="../quat.html#quat.Quaternion.inv">[docs]</a>    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Inverse of a quaternion.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">Quaternion</span><span class="p">(</span><span class="n">q_inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">))</span></div>
    
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;Quaternion &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
<div class="viewcode-block" id="Quaternion.export"><a class="viewcode-back" href="../quat.html#quat.Quaternion.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;rotmat&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Conversion to other formats. May be slow for &quot;Fick&quot;, &quot;Helmholtz&quot;, and &quot;Euler&quot;.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        to : string</span>
<span class="sd">            content of returned values</span>
<span class="sd">            </span>
<span class="sd">            * &#39;rotmat&#39; : rotation matrices (default), each flattened to a 9-dim vector</span>
<span class="sd">            * &#39;Euler&#39; : Euler angles</span>
<span class="sd">            * &#39;Fick&#39; : Fick angles</span>
<span class="sd">            * &#39;Helmholtz&#39; : Helmholtz angles</span>
<span class="sd">            * &#39;vector&#39; : vector part of the quaternion</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray, with the specified content</span>


<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; q = Quaternion([0,0.2,0.1])</span>
<span class="sd">        &gt;&gt;&gt; rm = q.export()</span>
<span class="sd">        &gt;&gt;&gt; fick = q.export(&#39;Fick&#39;)</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">to</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rotmat&#39;</span> <span class="p">:</span>
           <span class="k">return</span> <span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;rotmat&#39;</span><span class="p">)</span>
       
        <span class="k">if</span> <span class="n">to</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;vector&#39;</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">to</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;euler&#39;</span><span class="p">:</span>
            <span class="n">Euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rm</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rm</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
               <span class="n">Euler</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rotmat</span><span class="o">.</span><span class="n">rotmat2Euler</span><span class="p">(</span><span class="n">rm</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Euler</span>
        
        <span class="k">if</span> <span class="n">to</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fick&#39;</span><span class="p">:</span>
            <span class="n">Fick</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rm</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rm</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
               <span class="n">Fick</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rotmat</span><span class="o">.</span><span class="n">rotmat2Fick</span><span class="p">(</span><span class="n">rm</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Fick</span>
        
        <span class="k">if</span> <span class="n">to</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;helmholtz&#39;</span><span class="p">:</span>
            <span class="n">Helmholtz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rm</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">rm</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
               <span class="n">Helmholtz</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">rotmat</span><span class="o">.</span><span class="n">rotmat2Helmholtz</span><span class="p">(</span><span class="n">rm</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">Helmholtz</span></div></div>
        
<div class="viewcode-block" id="convert"><a class="viewcode-back" href="../quat.html#quat.convert">[docs]</a><span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">quat</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;rotmat&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Calculate the rotation matrix corresponding to the quaternion. If</span>
<span class="sd">    &quot;inQuat&quot; contains more than one quaternion, the matrix is flattened (to</span>
<span class="sd">    facilitate the work with rows of quaternions), and can be restored to</span>
<span class="sd">    matrix form by &quot;reshaping&quot; the resulting rows into a (3,3) shape.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inQuat : array_like, shape ([3,4],) or (N,[3,4])</span>
<span class="sd">        quaternions or quaternion vectors</span>
<span class="sd">    to : string</span>
<span class="sd">        Has to be one of the following:</span>
<span class="sd">    </span>
<span class="sd">        - rotmat : rotation matrix</span>
<span class="sd">        - Gibbs  : Gibbs vector</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rotMat : corresponding rotation matrix/matrices (flattened)</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math::</span>
<span class="sd">        {\\bf{R}} = \\left( {\\begin{array}{*{20}{c}}</span>
<span class="sd">        {q_0^2 + q_1^2 - q_2^2 - q_3^2}&amp;{2({q_1}{q_2} - {q_0}{q_3})}&amp;{2({q_1}{q_3} + {q_0}{q_2})}\\\\</span>
<span class="sd">        {2({q_1}{q_2} + {q_0}{q_3})}&amp;{q_0^2 - q_1^2 + q_2^2 - q_3^2}&amp;{2({q_2}{q_3} - {q_0}{q_1})}\\\\</span>
<span class="sd">        {2({q_1}{q_3} - {q_0}{q_2})}&amp;{2({q_2}{q_3} + {q_0}{q_1})}&amp;{q_0^2 - q_1^2 - q_2^2 + q_3^2} \\\\</span>
<span class="sd">        \\end{array}} \\right)</span>

<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; r = quat.convert([0, 0, 0.1], to=&#39;rotmat&#39;)</span>
<span class="sd">    &gt;&gt;&gt; r.shape</span>
<span class="sd">    (1, 9)</span>
<span class="sd">    &gt;&gt;&gt; r.reshape((3,3))</span>
<span class="sd">    array([[ 0.98      , -0.19899749,  0.        ],</span>
<span class="sd">        [ 0.19899749,  0.98      ,  0.        ],</span>
<span class="sd">        [ 0.        ,  0.        ,  1.        ]])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">to</span> <span class="o">==</span> <span class="s1">&#39;rotmat&#39;</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">R</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">elif</span> <span class="n">to</span> <span class="o">==</span> <span class="s1">&#39;Gibbs&#39;</span><span class="p">:</span>
        <span class="n">q_0</span> <span class="o">=</span> <span class="n">q_scalar</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>      <span class="c1"># cos(alpha/2)</span>
        <span class="n">gibbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_vector</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">q_0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>    <span class="c1"># tan = sin/cos</span>
        
        <span class="k">return</span> <span class="n">gibbs</span></div>
        
        
<div class="viewcode-block" id="deg2quat"><a class="viewcode-back" href="../quat.html#quat.deg2quat">[docs]</a><span class="k">def</span> <span class="nf">deg2quat</span><span class="p">(</span><span class="n">inDeg</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Convert axis-angles or plain degree into the corresponding quaternion values.</span>
<span class="sd">    Can be used with a plain number or with an axis angle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inDeg : float or (N,3)</span>
<span class="sd">        quaternion magnitude or quaternion vectors.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outQuat : float or array (N,3)</span>
<span class="sd">        number or quaternion vector.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        | \\vec{q} | = sin(\\theta/2)</span>

<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quat.deg2quat(array([[10,20,30], [20,30,40]]))</span>
<span class="sd">    array([[ 0.08715574,  0.17364818,  0.25881905],</span>
<span class="sd">       [ 0.17364818,  0.25881905,  0.34202014]])</span>

<span class="sd">    &gt;&gt;&gt; quat.deg2quat(10)</span>
<span class="sd">    0.087155742747658166</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">deg</span> <span class="o">=</span> <span class="p">(</span><span class="n">inDeg</span><span class="o">+</span><span class="mi">180</span><span class="p">)</span><span class="o">%</span><span class="mi">360</span><span class="o">-</span><span class="mi">180</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">deg</span> <span class="o">*</span> <span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="q_conj"><a class="viewcode-back" href="../quat.html#quat.q_conj">[docs]</a><span class="k">def</span> <span class="nf">q_conj</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Conjugate quaternion </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: array_like, shape ([3,4],) or (N,[3/4])</span>
<span class="sd">        quaternion or quaternion vectors</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qconj : conjugate quaternion(s)</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt;  quat.q_conj([0,0,0.1])</span>
<span class="sd">    array([ 0.99498744, -0.        , -0.        , -0.1       ])</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; quat.q_conj([[cos(0.1),0,0,sin(0.1)],</span>
<span class="sd">    &gt;&gt;&gt;    [cos(0.2), 0, sin(0.2), 0]])</span>
<span class="sd">    array([[ 0.99500417, -0.        , -0.        , -0.09983342],</span>
<span class="sd">           [ 0.98006658, -0.        , -0.19866933, -0.        ]])</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">qConj</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">qConj</span><span class="o">=</span><span class="n">qConj</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">qConj</span></div>


<div class="viewcode-block" id="q_inv"><a class="viewcode-back" href="../quat.html#quat.q_inv">[docs]</a><span class="k">def</span> <span class="nf">q_inv</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Quaternion inversion </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: array_like, shape ([3,4],) or (N,[3/4])</span>
<span class="sd">        quaternion or quaternion vectors</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qinv : inverse quaternion(s)</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math::</span>
<span class="sd">          q^{-1} = \\frac{q_0 - \\vec{q}}{|q|^2}</span>

<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt;  quat.q_inv([0,0,0.1])</span>
<span class="sd">    array([-0., -0., -0.1])</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; quat.q_inv([[cos(0.1),0,0,sin(0.1)],</span>
<span class="sd">    &gt;&gt;&gt; [cos(0.2),0,sin(0.2),0]])</span>
<span class="sd">    array([[ 0.99500417, -0.        , -0.        , -0.09983342],</span>
<span class="sd">           [ 0.98006658, -0.        , -0.19866933, -0.        ]])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">q</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">qConj</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">qConj</span><span class="o">.</span><span class="n">T</span> <span class="o">/</span> <span class="n">qLength</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="q_mult"><a class="viewcode-back" href="../quat.html#quat.q_mult">[docs]</a><span class="k">def</span> <span class="nf">q_mult</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Quaternion multiplication: Calculates the product of two quaternions r = p * q</span>
<span class="sd">    If one of both of the quaterions have only three columns,</span>
<span class="sd">    the scalar component is calculated such that the length</span>
<span class="sd">    of the quaternion is one.</span>
<span class="sd">    The lengths of the quaternions have to match, or one of</span>
<span class="sd">    the two quaternions has to have the length one.</span>
<span class="sd">    If both p and q only have 3 components, the returned quaternion</span>
<span class="sd">    also only has 3 components (i.e. the quaternion vector)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p,q : array_like, shape ([3,4],) or (N,[3,4])</span>
<span class="sd">        quaternions or quaternion vectors</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    r : quaternion or quaternion vector (if both</span>
<span class="sd">        p and q are contain quaternion vectors).</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math::</span>
<span class="sd">        q \\circ p = \\sum\\limits_{i=0}^3 {q_i I_i} * \\sum\\limits_{j=0}^3 \\</span>
<span class="sd">        {p_j I_j} = (q_0 p_0 - \\vec{q} \\cdot \\vec{p}) + (q_0 \\vec{p} + p_0 \\</span>
<span class="sd">        \\vec{q} + \\vec{q} \\times \\vec{p}) \\cdot \\vec{I}</span>
<span class="sd">    </span>
<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; p = [cos(0.2), 0, 0, sin(0.2)]</span>
<span class="sd">    &gt;&gt;&gt; q = [[0, 0, 0.1],</span>
<span class="sd">    &gt;&gt;&gt;    [0, 0.1, 0]]</span>
<span class="sd">    &gt;&gt;&gt; r = quat.q_mult(p,q)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">flag3D</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span> <span class="o">&amp;</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">flag3D</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> \
            <span class="s1">&#39;Both arguments in the quaternion multiplication must have the same number of rows, unless one has only one row.&#39;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">q</span><span class="p">)):</span>
        <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

    <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">flag3D</span><span class="p">:</span>
        <span class="c1"># for rotations &gt; 180 deg</span>
        <span class="n">r</span><span class="p">[:,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="p">[:,</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="quat2deg"><a class="viewcode-back" href="../quat.html#quat.quat2deg">[docs]</a><span class="k">def</span> <span class="nf">quat2deg</span><span class="p">(</span><span class="n">inQuat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate the axis-angle corresponding to a given quaternion.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inQuat: float, or array_like, shape ([3/4],) or (N,[3/4])</span>
<span class="sd">        quaternion(s) or quaternion vector(s)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    axAng : corresponding axis angle(s)</span>
<span class="sd">        float, or shape (3,) or (N,3)</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    .. math::</span>
<span class="sd">        | \\vec{q} | = sin(\\theta/2)</span>

<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quat.quat2deg(0.1)</span>
<span class="sd">    array([ 11.47834095])</span>

<span class="sd">    &gt;&gt;&gt; quat.quat2deg([0.1, 0.1, 0])</span>
<span class="sd">    array([ 11.47834095,  11.47834095,   0.        ])</span>

<span class="sd">    &gt;&gt;&gt; quat.quat2deg([cos(0.1), 0, sin(0.1), 0])</span>
<span class="sd">    array([  0.       ,  11.4591559,   0.       ])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">q_vector</span><span class="p">(</span><span class="n">inQuat</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span></div>



<div class="viewcode-block" id="quat2seq"><a class="viewcode-back" href="../quat.html#quat.quat2seq">[docs]</a><span class="k">def</span> <span class="nf">quat2seq</span><span class="p">(</span><span class="n">quats</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="s1">&#39;nautical&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function takes a quaternion, and calculates the corresponding</span>
<span class="sd">    angles for sequenctial rotations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    quats : ndarray, nx4</span>
<span class="sd">        input quaternions</span>
<span class="sd">    seq : string</span>
<span class="sd">        Has to be one the following:</span>
<span class="sd">        </span>
<span class="sd">        - Euler ... Rz * Rx * Rz</span>
<span class="sd">        - Fick ... Rz * Ry * Rx</span>
<span class="sd">        - nautical ... same as &quot;Fick&quot;</span>
<span class="sd">        - Helmholtz ... Ry * Rz * Rx</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sequence : ndarray, nx3</span>
<span class="sd">        corresponding angles [deg]</span>
<span class="sd">        same sequence as in the rotation matrices</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quat.quat2seq([0,0,0.1])</span>
<span class="sd">    array([[ 11.47834095,  -0.        ,   0.        ]])</span>

<span class="sd">    &gt;&gt;&gt; quaternions = [[0,0,0.1], [0,0.2,0]]</span>
<span class="sd">    skin.quat.quat2seq(quaternions)</span>
<span class="sd">    array([[ 11.47834095,  -0.        ,   0.        ],</span>
<span class="sd">           [  0.        ,  23.07391807,   0.        ]])</span>
<span class="sd">       </span>
<span class="sd">    &gt;&gt;&gt; skin.quat.quat2seq(quaternions, &#39;nautical&#39;)</span>
<span class="sd">    array([[ 11.47834095,  -0.        ,   0.        ],</span>
<span class="sd">           [  0.        ,  23.07391807,   0.        ]])</span>
<span class="sd">           </span>
<span class="sd">    &gt;&gt;&gt; skin.quat.quat2seq(quaternions, &#39;Euler&#39;)</span>
<span class="sd">    array([[ 11.47834095,   0.        ,   0.        ],</span>
<span class="sd">           [ 90.        ,  23.07391807,  -90.        ]])</span>

<span class="sd">           </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Ensure that it also works for a single quaternion</span>
    <span class="n">quats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">quats</span><span class="p">)</span>
    
    <span class="c1"># If only the quaternion vector is entered, extend it to a full unit quaternion</span>
    <span class="k">if</span> <span class="n">quats</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">quats</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">quats</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seq</span> <span class="o">==</span><span class="s1">&#39;Fick&#39;</span> <span class="ow">or</span> <span class="n">seq</span> <span class="o">==</span><span class="s1">&#39;nautical&#39;</span><span class="p">:</span>
        <span class="n">R_zx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">R_yx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">R_zy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">phi</span>  <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_zx</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_yx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">psi</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_zy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
    
    <span class="k">elif</span> <span class="n">seq</span> <span class="o">==</span> <span class="s1">&#39;Helmholtz&#39;</span><span class="p">:</span>
        <span class="n">R_yx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">R_zx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">R_yz</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">quats</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">quats</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_yx</span><span class="p">)</span>
        <span class="n">phi</span>  <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_zx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">psi</span>  <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">R_yz</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">psi</span><span class="p">))</span>
        
    <span class="k">elif</span> <span class="n">seq</span> <span class="o">==</span> <span class="s1">&#39;Euler&#39;</span><span class="p">:</span>
        <span class="n">Rs</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">quats</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;rotmat&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">Rs</span><span class="p">[:,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        
        <span class="c1"># special handling for (beta == 0)</span>
        <span class="n">bz</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">==</span> <span class="mi">0</span>  
        
        <span class="c1"># there the gamma-values are set to zero, since alpha/gamma is degenerated</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
        
        <span class="n">alpha</span><span class="p">[</span><span class="n">bz</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">Rs</span><span class="p">[</span><span class="n">bz</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">gamma</span><span class="p">[</span><span class="n">bz</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">alpha</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Rs</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">Rs</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">gamma</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Rs</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rs</span><span class="p">[</span><span class="o">~</span><span class="n">bz</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input parameter </span><span class="si">{0}</span><span class="s1"> not known&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span></div>

<div class="viewcode-block" id="q_vector"><a class="viewcode-back" href="../quat.html#quat.q_vector">[docs]</a><span class="k">def</span> <span class="nf">q_vector</span><span class="p">(</span><span class="n">inQuat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extract the quaternion vector from a full quaternion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inQuat : array_like, shape ([3,4],) or (N,[3,4])</span>
<span class="sd">        quaternions or quaternion vectors.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vect : array, shape (3,) or (N,3)</span>
<span class="sd">        corresponding quaternion vectors</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quat.q_vector([[np.cos(0.2), 0, 0, np.sin(0.2)],[cos(0.1), 0, np.sin(0.1), 0]])</span>
<span class="sd">    array([[ 0.        ,  0.        ,  0.19866933],</span>
<span class="sd">           [ 0.        ,  0.09983342,  0.        ]])</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">inQuat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inQuat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inQuat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">inQuat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">inQuat</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vect</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="n">vect</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vect</span></div>

<div class="viewcode-block" id="q_scalar"><a class="viewcode-back" href="../quat.html#quat.q_scalar">[docs]</a><span class="k">def</span> <span class="nf">q_scalar</span><span class="p">(</span><span class="n">inQuat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Extract the quaternion scalar from a full quaternion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inQuat : array_like, shape ([3,4],) or (N,[3,4])</span>
<span class="sd">        quaternions or quaternion vectors.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vect : array, shape (1,) or (N,1)</span>
<span class="sd">        Corresponding quaternion scalar.</span>
<span class="sd">        If the input is only the quaternion-vector, the scalar part for a unit</span>
<span class="sd">        quaternion is calculated and returned.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quat.q_scalar([[np.cos(0.2), 0, 0, np.sin(0.2)],[np.cos(0.1), 0, np.sin(0.1), 0]])</span>
<span class="sd">    array([ 0.98006658,  0.99500417])    </span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">inQuat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inQuat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inQuat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">inQuat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">inQuat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">scalar</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">scalar</span> <span class="o">=</span> <span class="n">scalar</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">scalar</span></div>


<div class="viewcode-block" id="unit_q"><a class="viewcode-back" href="../quat.html#quat.unit_q">[docs]</a><span class="k">def</span> <span class="nf">unit_q</span><span class="p">(</span><span class="n">inData</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Utility function, which turns a quaternion vector into a unit quaternion.</span>
<span class="sd">    If the input is already a full quaternion, the output equals the input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inData : array_like, shape (3,) or (N,3)</span>
<span class="sd">        quaternions or quaternion vectors</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    quats : array, shape (4,) or (N,4)</span>
<span class="sd">        corresponding unit quaternions.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    More info under </span>
<span class="sd">    http://en.wikipedia.org/wiki/Quaternion</span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; quats = array([[0,0, sin(0.1)],[0, sin(0.2), 0]])</span>
<span class="sd">    &gt;&gt;&gt; quat.unit_q(quats)</span>
<span class="sd">    array([[ 0.99500417,  0.        ,  0.        ,  0.09983342],</span>
<span class="sd">           [ 0.98006658,  0.        ,  0.19866933,  0.        ]])</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">inData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">inData</span><span class="p">)</span>
    <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">inData</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">!=</span><span class="mi">3</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">n</span><span class="o">!=</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quaternion must have 3 or 4 columns&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">qLength</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inData</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">numLimit</span> <span class="o">=</span> <span class="mf">1e-12</span>
        <span class="c1"># Check for numerical problems</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">qLength</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">numLimit</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quaternion is too long!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Correct for numerical problems</span>
            <span class="n">qLength</span><span class="p">[</span><span class="n">qLength</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qLength</span><span class="p">)],</span> <span class="n">inData</span><span class="p">))</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outData</span> <span class="o">=</span> <span class="n">inData</span>
        
    <span class="k">return</span> <span class="n">outData</span></div>

<div class="viewcode-block" id="calc_quat"><a class="viewcode-back" href="../quat.html#quat.calc_quat">[docs]</a><span class="k">def</span> <span class="nf">calc_quat</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">CStype</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take an angular velocity (in rad/s), and convert it into the</span>
<span class="sd">    corresponding orientation quaternion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    omega : array, shape (3,) or (N,3)</span>
<span class="sd">        angular velocity [rad/s].</span>
<span class="sd">    q0 : array (3,)</span>
<span class="sd">        vector-part of quaternion (!!)</span>
<span class="sd">    rate : float</span>
<span class="sd">        sampling rate (in [Hz])</span>
<span class="sd">    CStype:  string</span>
<span class="sd">        coordinate_system, space-fixed (&quot;sf&quot;) or body_fixed (&quot;bf&quot;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    quats : array, shape (N,4)</span>
<span class="sd">        unit quaternion vectors.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    1) The output has the same length as the input. As a consequence, the last velocity vector is ignored.</span>
<span class="sd">    2) For angular velocity with respect to space (&quot;sf&quot;), the orientation is given by</span>

<span class="sd">      .. math::</span>
<span class="sd">          q(t) = \\Delta q(t_n) \\circ \\Delta q(t_{n-1}) \\circ ... \\circ \\Delta q(t_2) \\circ \\Delta q(t_1) \\circ q(t_0)</span>

<span class="sd">      .. math::</span>
<span class="sd">        \\Delta \\vec{q_i} = \\vec{n(t)}\\sin (\\frac{\\Delta \\phi (t_i)}{2}) = \\frac{\\vec \\omega (t_i)}{\\left| {\\vec \\omega (t_i)} \\right|}\\sin \\left( \\frac{\\left| {\\vec \\omega ({t_i})} \\right|\\Delta t}{2} \\right)</span>

<span class="sd">    3) For angular velocity with respect to the body (&quot;bf&quot;), the sequence of quaternions is inverted.</span>

<span class="sd">    4) Take care that you choose a high enough sampling rate!</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; v0 = np.r_[0., 0., 100.] * np.pi/180.</span>
<span class="sd">    &gt;&gt;&gt; omega = np.tile(v0, (1000,1))</span>
<span class="sd">    &gt;&gt;&gt; rate = 100</span>
<span class="sd">    &gt;&gt;&gt; out = quat.calc_quat(omega, [0., 0., 0.], rate, &#39;sf&#39;)</span>
<span class="sd">    array([[ 1.        ,  0.        ,  0.        ,  0.        ],</span>
<span class="sd">       [ 0.99996192,  0.        ,  0.        ,  0.00872654],</span>
<span class="sd">       [ 0.9998477 ,  0.        ,  0.        ,  0.01745241],</span>
<span class="sd">       ..., </span>
<span class="sd">       [-0.74895572,  0.        ,  0.        ,  0.66262005],</span>
<span class="sd">       [-0.75470958,  0.        ,  0.        ,  0.65605903],</span>
<span class="sd">       [-0.76040597,  0.        ,  0.        ,  0.64944805]])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">omega_05</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># The following is (approximately) the quaternion-equivalent of the trapezoidal integration (cumtrapz)</span>
    <span class="k">if</span> <span class="n">omega_05</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">omega_05</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">omega_05</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">omega_05</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="n">omega_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">omega_05</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">omega_nonZero</span> <span class="o">=</span> <span class="n">omega_t</span><span class="o">&gt;</span><span class="mi">0</span>

    <span class="c1"># initialize the quaternion</span>
    <span class="n">q_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">omega_05</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">q_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">omega_05</span><span class="p">),</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">q_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">q0</span><span class="p">)</span>

    <span class="c1"># magnitude of position steps</span>
    <span class="n">dq_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega_t</span><span class="p">[</span><span class="n">omega_nonZero</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">rate</span><span class="p">))</span>

    <span class="n">q_delta</span><span class="p">[</span><span class="n">omega_nonZero</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">omega_05</span><span class="p">[</span><span class="n">omega_nonZero</span><span class="p">,:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">dq_total</span><span class="o">/</span><span class="n">omega_t</span><span class="p">[</span><span class="n">omega_nonZero</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">omega_05</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">q_delta</span><span class="p">[</span><span class="n">ii</span><span class="p">,:])</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">q_pos</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">CStype</span> <span class="o">==</span> <span class="s1">&#39;sf&#39;</span><span class="p">:</span>            
            <span class="n">qm</span> <span class="o">=</span> <span class="n">q_mult</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">CStype</span> <span class="o">==</span> <span class="s1">&#39;bf&#39;</span><span class="p">:</span>
            <span class="n">qm</span> <span class="o">=</span> <span class="n">q_mult</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span><span class="n">q1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I don&#39;&#39;t know this type of coordinate system!&#39;</span><span class="p">)</span>
        <span class="n">q_pos</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">qm</span>

    <span class="k">return</span> <span class="n">q_pos</span></div>


<div class="viewcode-block" id="calc_angvel"><a class="viewcode-back" href="../quat.html#quat.calc_angvel">[docs]</a><span class="k">def</span> <span class="nf">calc_angvel</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">winSize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Take a quaternion, and convert it into the</span>
<span class="sd">    corresponding angular velocity</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q : array, shape (N,[3,4])</span>
<span class="sd">        unit quaternion vectors.</span>
<span class="sd">    rate : float</span>
<span class="sd">        sampling rate (in [Hz])</span>
<span class="sd">    winSize : integer</span>
<span class="sd">        window size for the calculation of the velocity.</span>
<span class="sd">        Has to be odd.</span>
<span class="sd">    order : integer</span>
<span class="sd">        Order of polynomial used by savgol to calculate the first derivative</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    angvel : array, shape (3,) or (N,3)</span>
<span class="sd">        angular velocity [rad/s].</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The angular velocity is given by</span>

<span class="sd">      .. math::</span>
<span class="sd">        \\omega = 2 * \\frac{dq}{dt} \\circ q^{-1}</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; rate = 1000</span>
<span class="sd">    &gt;&gt;&gt; t = np.arange(0,10,1/rate)</span>
<span class="sd">    &gt;&gt;&gt; x = 0.1 * np.sin(t)</span>
<span class="sd">    &gt;&gt;&gt; y = 0.2 * np.sin(t)</span>
<span class="sd">    &gt;&gt;&gt; z = np.zeros_like(t)</span>
<span class="sd">    array([[ 0.20000029,  0.40000057,  0.        ],</span>
<span class="sd">           [ 0.19999989,  0.39999978,  0.        ],</span>
<span class="sd">           [ 0.19999951,  0.39999901,  0.        ]])</span>
<span class="sd">            .......</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">winSize</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Window size must be odd!&#39;</span><span class="p">)</span>
    
    <span class="n">numCols</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">numCols</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">numCols</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;quaternions must have 3 or 4 columns&#39;</span><span class="p">)</span>
    
    <span class="c1"># This has to be done: otherwise q_mult will &quot;complete&quot; dq_dt to be a unit</span>
    <span class="c1"># quaternion, resulting in wrong value</span>
    <span class="k">if</span> <span class="n">numCols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">unit_q</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    
    <span class="n">dq_dt</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">winSize</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">rate</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">angVel</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">q_mult</span><span class="p">(</span><span class="n">dq_dt</span><span class="p">,</span> <span class="n">q_inv</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">angVel</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span></div>
    
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;These are some simple tests to see if the functions produce the</span>
<span class="sd">    proper output.</span>
<span class="sd">    More extensive tests are found in tests/test_quat.py&#39;&#39;&#39;</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">quat2seq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)),</span> <span class="n">seq</span><span class="o">=</span><span class="s1">&#39;Euler&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    from skinematics.vector import rotate_vector</span>
<span class="sd">    </span>
<span class="sd">    v0 = np.r_[0., 0., 100.] * np.pi/180.</span>
<span class="sd">    vel = np.tile(v0, (1000,1))</span>
<span class="sd">    rate = 100</span>
<span class="sd">    out = calc_quat(vel, [0., 0., 0.], rate, &#39;sf&#39;)</span>
<span class="sd">    </span>
<span class="sd">    rate = 1000</span>
<span class="sd">    t = np.arange(0,10,1./rate)</span>
<span class="sd">    x = 0.1 * np.sin(t)</span>
<span class="sd">    y = 0.2 * np.sin(t)</span>
<span class="sd">    z = np.zeros_like(t)</span>
<span class="sd">    </span>
<span class="sd">    q = np.column_stack( (x,y,z) )</span>
<span class="sd">    vel = calc_angvel(q, rate, 5, 2)</span>
<span class="sd">    qReturn = vel2quat(vel, q[0], rate, &#39;sf&#39; )</span>
<span class="sd">    </span>
<span class="sd">    plt.plot(q)</span>
<span class="sd">    plt.plot(qReturn[:,1:],&#39;--&#39;)</span>
<span class="sd">    plt.show()</span>
<span class="sd">    </span>
<span class="sd">    q = Quaternion(np.array([0,0,10]), &#39;Fick&#39;)</span>
<span class="sd">    print(q)</span>
<span class="sd">    rm = q.export(to=&#39;rotmat&#39;)</span>
<span class="sd">    print(rm)</span>
<span class="sd">    q2 = Quaternion(rm, inType=&#39;rotmat&#39;) </span>
<span class="sd">    print(q2)</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">    a = np.r_[np.cos(0.1), 0,0,np.sin(0.1)]</span>
<span class="sd">    b = np.r_[np.cos(0.1),0,np.sin(0.1), 0]</span>
<span class="sd">    c = np.vstack((a,b))</span>
<span class="sd">    d = np.r_[np.sin(0.1), 0, 0]</span>
<span class="sd">    e = np.r_[2, 0, np.sin(0.1), 0]</span>

<span class="sd">    print(q_mult(a,a))</span>
<span class="sd">    print(q_mult(a,b))</span>
<span class="sd">    print(q_mult(c,c))</span>
<span class="sd">    print(q_mult(c,a))</span>
<span class="sd">    print(q_mult(d,d))</span>

<span class="sd">    print(&#39;The inverse of {0} is {1}&#39;.format(a, q_inv(a)))</span>
<span class="sd">    print(&#39;The inverse of {0} is {1}&#39;.format(d, q_inv(d)))</span>
<span class="sd">    print(&#39;The inverse of {0} is {1}&#39;.format(e, q_inv(e)))</span>
<span class="sd">    print(q_mult(e, q_inv(e)))</span>

<span class="sd">    print(q_vector(a))</span>
<span class="sd">    print(&#39;{0} is {1} degree&#39;.format(a, quat2deg(a)))</span>
<span class="sd">    print(&#39;{0} is {1} degree&#39;.format(c, quat2deg(c)))</span>
<span class="sd">    print(quat2deg(0.2))</span>
<span class="sd">    x = np.r_[1,0,0]</span>
<span class="sd">    vNull = np.r_[0,0,0]</span>
<span class="sd">    print(rotate_vector(x, a))</span>

<span class="sd">    v0 = [0., 0., 100.]</span>
<span class="sd">    vel = np.tile(v0, (1000,1))</span>
<span class="sd">    rate = 100</span>
<span class="sd">    </span>
<span class="sd">    out = vel2quat(vel, [0., 0., 0.], rate, &#39;sf&#39;)</span>
<span class="sd">    print(out[-1:])</span>
<span class="sd">    </span>
<span class="sd">    plt.plot(out[:,1:4])</span>
<span class="sd">    plt.show()</span>
<span class="sd">    </span>
<span class="sd">    print(deg2quat(15))</span>
<span class="sd">    print(deg2quat(quat2deg(a)))</span>
<span class="sd">    </span>
<span class="sd">    q = np.array([[0, 0, np.sin(0.1)],</span>
<span class="sd">               [0, np.sin(0.01), 0]])</span>
<span class="sd">    rMat = convert(q, to=&#39;rotmat)</span>
<span class="sd">    print(rMat[1].reshape((3,3)))</span>
<span class="sd">    qNew = rotmat2quat(rMat)</span>
<span class="sd">    print(qNew)</span>
<span class="sd">    </span>
<span class="sd">    q = Quaternion(np.array([0,0,0.5]))</span>
<span class="sd">    p = Quaternion(np.array([[0,0,0.5], [0,0,0.1]]))</span>
<span class="sd">    r = Quaternion([0,0,0.5])</span>
<span class="sd">    print(p*q)</span>
<span class="sd">    print(q*3)</span>
<span class="sd">    print(q*pi)</span>
<span class="sd">    print(q/p)</span>
<span class="sd">    print(q/5)</span>
<span class="sd">    </span>
<span class="sd">    Fick = p.export(&#39;Fick&#39;)</span>
<span class="sd">    Q_fick = q.export(&#39;Fick&#39;)</span>
<span class="sd">    </span>
<span class="sd">    import pprint</span>
<span class="sd">    pprint.pprint(Fick)</span>
<span class="sd">    pprint.pprint(np.rad2deg(Fick))</span>
<span class="sd">    </span>
<span class="sd">    p = Quaternion(np.array([[0,0,0.5], [0,0,0.1], [0,0,0.1]]))</span>
<span class="sd">    p[1:] = [[0,0,0],[0,0,0.01]]</span>
<span class="sd">    print(p)</span>

<span class="sd">    &#39;&#39;&#39;</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/skinematics.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">skinematics 0.8.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, thomas haslwanter.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.7.
    </div>
  </body>
</html>
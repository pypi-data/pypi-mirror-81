{% extends "vendor/base.html" %}
{% load i18n %}

{% block vendor_content %}
<div class='row mx-md-5 px-md-3'>
  <div class='col-12 my-4'>
    <h1>{% trans 'SECURE CHECKOUT' %}</h1>
  </div>
  <div class='col-md-8'>
    <div class="card border-0">
      <div class="card-header mb-0 text-white p-0 border-0 mb-3" id="account_info">
        <div
          class="btn-group w-100 {% if request.resolver_match.url_name == 'checkout-account' %}bg-accent{% else %}bg-accenthover{% endif %}">
          <div class="bg-white font-weight-bold text-dark border-0 px-3 py-3 m-0" style="opacity: .5;">
            1
          </div>
          <div class="font-weight-bold text-left text-white border-0 py-3 ml-3">
            Info
          </div>
          {% if request.resolver_match.url_name != 'checkout-account' %}
          <div class='d-flex ml-auto mr-3 align-items-center'>
            <iconify-icon data-icon="ic-baseline-check" class="check"></iconify-icon>
          </div>
          {% endif %}
        </div>
      </div>

      {% if request.resolver_match.url_name == 'checkout-account' %}
      <div id="collapseOne" class="collapse show" aria-labelledby="account_info" data-parent="#checkout_accordion">
        <div class="card-body">
          <form method="post">
            {% csrf_token %}
            <h3 class='card-title'>
              Account Address
            </h3>
            {% include "./includes/account_info_form.html" with account_information_form=form %}
            <button class="btn btn-primary" type="submit">Continue</button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="card border-0">
      <div class="card-header mb-0 text-white p-0 border-0 mb-3" id="billing_info">
        <div
          class="btn-group w-100 {% if request.resolver_match.url_name == 'checkout-payment' %}bg-accent{% else %}bg-accenthover{% endif %}">
          <div class="bg-white font-weight-bold text-dark rounded-0 border-0 px-3 py-3 m-0" style="opacity: .5;">
            2
          </div>
          <div class="font-weight-bold text-left text-white rounded-0 border-0 py-3 ml-3">
            Billing
          </div>
          {% if request.resolver_match.url_name == 'checkout-review' %}
          <div class='d-flex ml-auto mr-3 align-items-center'>
            <iconify-icon data-icon="ic-baseline-check" class="check"></iconify-icon>
          </div>
          {% endif %}
        </div>
      </div>

      {% if request.resolver_match.url_name == 'checkout-payment' %}
      <div id="collapseTwo" class="collapse show" aria-labelledby="billing_info" data-parent="#checkout_accordion">
        <div class="card-body">
          <form id="payment-form" method="post">
            {% csrf_token %}
            <h3 class='card-title'>
              Billing Address
            </h3>
            {% include "./includes/billing_address_form.html" with billing_address_form=billing_address_form %}
            <div id="shipping-address" class='d-none'>
              <p class="mb-0">{{invoice.shipping_address.address_1}},
                {{invoice.shipping_address.address_2|default_if_none:""}}</p>
              <p>{{invoice.shipping_address.state}},
                {{invoice.shipping_address.get_country_display}},{{invoice.shipping_address.postal_code}}
              </p>
            </div>
            <h3 class='card-title'>
              Payment Method
            </h3>
            {% include "./includes/payment_form.html" with credit_card_form=credit_card_form %}
          </form>
          <button form="payment-form" name='only-validate' class="btn btn-primary" type="submit">Continue</button>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="card border-0">
      <div class="card-header mb-0 text-white p-0 border-0 mb-3" id="review">
        <div
          class="btn-group w-100 {% if request.resolver_match.url_name == 'checkout-review' %}bg-accent{% else %}bg-accenthover{% endif %}">
          <div class="bg-white font-weight-bold text-dark rounded-0 border-0 px-3 py-3 m-0" style="opacity: .5;">
            3
          </div>
          <div class="font-weight-bold text-left text-white rounded-0 border-0 py-3 ml-3">
            Review
          </div>
        </div>
      </div>

      {% if request.resolver_match.url_name == 'checkout-review' %}
      <div id="collapseThree" class="collapse show" aria-labelledby="review" data-parent="#checkout_accordion">
        <div class="card-body">
          <h3 class='card-title'>
            <div class='d-flex flex-row align-items-center'>
              <div>Account Address</div>
              <div class="ml-auto">
                <a class="text-primary" href="{% url 'vendor:checkout-account' %}">
                  <i class="fas fa-pen" style="display: inline-block; width: 21px; height: 21px;"></i>
                </a>
              </i>
            </div>
          </h3>
          <p id="review-account-name" class="mb-0">{{user.first_name}} {{user.last_name}}</p>
          <p id="review-account-email" class="mb-0">{{user.email}}</p>
          <p class="mb-0">{{invoice.shipping_address.address_1}},
            {{invoice.shipping_address.address_2|default_if_none:""}}</p>
          <p>{{invoice.shipping_address.state}},
            {{invoice.shipping_address.country}},{{invoice.shipping_address.postal_code}}
          </p>
          <h3 class='card-title'>
            <div class='d-flex flex-row align-items-center'>
              <div>Billing Address</div>
              <div class="ml-auto">
                <a href="{% url 'vendor:checkout-payment' %}">
                  <iconify-icon data-icon="ic-baseline-edit" class="text-primary" style="height: 21px;"></iconify-icon>
                </a>
              </div>
            </div>
          </h3>

          <p class="mb-0">{{request.session.billing_address_form.address_1}},
            {{request.session.billing_address_form.address_2|default_if_none:""}}</p>
          <p>{{request.session.billing_address_form.state}},
            {{request.session.billing_address_form.country}},{{request.session.billing_address_form.postal_code}}
          </p>
          <h3 class='card-title'>
            Payment Method
          </h3>
          <p class="mb-0">{{request.session.credit_card_form.full_name}}</p>
          <p>Card end in
            {{request.session.credit_card_form.card_number|slice:"-4:"}}</p>
          <form method="post">
            {% csrf_token %}
            <button class=" btn btn-primary" type="submit">Place Order</button>
          </form>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
  <div class="col-md-4 order-md-2 mb-4 mt-2">
    <h3 class="d-flex justify-content-between align-items-center mb-3">
      In Your Cart
    </h3>

    <ul class="list-group mb-3 border-0">
      {% for item in invoice.order_items.all %}
      <li class="px-0 d-flex justify-content-between lh-condensed">
        <div>
          <h6 class="my-0">{{ item.name }}</h6>
          <small class="text-muted">Unit Price: {{item.price}}</small>
          <small class="text-muted">Quantity: {{item.quantity}}</small>
        </div>
        <span class="text-muted">${{ item.total }}</span>
      </li>
      {% endfor %}

      <li class="px-0 border-0 d-flex justify-content-between">
        <span>Subtotal</span>
        <span>${{ invoice.subtotal }}</span>
      </li>

      <li class="px-0 justify-content-between" style="list-style-type: none;">
        <hr class="my-3 border-dark border-5" />
      </li>

      <li class="px-0 border-0 d-flex justify-content-between">
        <span class="font-weight-bolder">Total (USD)</span>
        <span class="text-primary">${{ invoice.total }}</span>
      </li>
    </ul>


    {% comment %}
    <form class="card p-2">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Promo code">
        <div class="input-group-append">
          <button type="submit" class="btn btn-secondary">Redeem</button>
        </div>
      </div>
    </form>
    {% endcomment %}
  </div>
</div>

{% block extra_js %}
<script>
  $('#id_same_as_shipping').prop("checked", false);
  $('#id_same_as_shipping').change(function () {
    console.log('in event');
    console.log($('#id_same_as_shipping').val());
    if ($('#id_same_as_shipping').val()) {
      $('.billing-address-form').toggleClass('d-none');
      $('#shipping-address').toggleClass('d-none');
    }
    // TODO: This needs to change in the future, very easy to break.
    if ($(".billing-address-form").hasClass('d-none')){
      $("#id_address_1").removeAttr('required');
      $("#id_locality").removeAttr('required');
      $("#id_state").removeAttr('required');
      $("#id_postal_code").removeAttr('required');
    }
    else {
      $("#id_address_1").attr('required', "");
      $("#id_locality").attr('required', "");
      $("#id_state").attr('required', "");
      $("#id_postal_code").attr('required', "");
    }
  });
</script>
{% endblock %}

{% endblock %}
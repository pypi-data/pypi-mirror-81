[tox]
# we install the package manually later
skipsdist=True

[testenv:basic]
# test the basic package

# suppress warnings
whitelist_externals = make
                      pytest

setenv = BORIS_SERVER_LOCATION = https://api-dev.whattolabel.com 

deps = pytest
       responses

commands = pip install .
           pytest tests/api/
           pytest tests/data/
           pytest tests/loss/
           pytest tests/models/
           pytest tests/transforms/
           # TODO: add tests for cli/upload/etc so we only have to run tests
           # temporary fix (run boris-magic and see if it works):
           boris-embed input_dir='data/'
           boris-train input_dir='data/' trainer.max_epochs=1 loader.batch_size=100 trainer.gpus=1
           boris-magic input_dir='data/' trainer.max_epochs=1 loader.batch_size=100 trainer.gpus=1  

[testenv:cuda]
# test the full package on the gpu

# suppress warnings              
whitelist_externals = make
                      pip

setenv = BORIS_SERVER_LOCATION = https://api-dev.whattolabel.com 

deps = pytest
       pytest-xdist
       responses

commands = 
           pip install torch==1.5.1+cu101 torchvision==0.6.1+cu101 -f https://download.pytorch.org/whl/torch_stable.html
           python setup.py install --local
           make test
           # TODO: add tests for cli/upload/etc so we only have to run tests
           # temporary fix (run boris-magic and see if it works):
           boris-magic input_dir='data' trainer.max_epochs=1 loader.batch_size=100 trainer.gpus=1
           boris-magic input_dir='data' trainer.max_epochs=1 loader.batch_size=100 trainer.gpus=1

[testenv:cpu]
# test the full package on the gpu

# suppress warnings              
whitelist_externals = make
                      pip

setenv = BORIS_SERVER_LOCATION = https://api-dev.whattolabel.com 
         CUDA_VISIBLE_DEVICES = -1

deps = pytest
       pytest-xdist
       responses

commands = 
           pip install torch==1.5.1+cu101 torchvision==0.6.1+cu101 -f https://download.pytorch.org/whl/torch_stable.html
           python setup.py install --local
           make test
           # TODO: add tests for cli/upload/etc so we only have to run tests
           # temporary fix (run boris-magic and see if it works):
           boris-magic input_dir='data' trainer.max_epochs=1 loader.batch_size=100 trainer.gpus=1


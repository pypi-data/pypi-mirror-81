{"version":3,"sources":["webpack:///./src/resources/markdown_worker.ts","webpack:///../src/rpc-wrapper.js","webpack:///./src/components/ha-markdown.ts","webpack:///./src/data/ws-templates.ts","webpack:///./src/panels/lovelace/cards/hui-markdown-card.ts"],"names":["addMethods","__webpack_require__","methods","module","exports","w","Worker","p","name","worker","c","callbacks","e","d","data","id","f","error","Object","Error","evt","document","method","Promise","a","b","type","params","customElement","HaMarkdown","property","Boolean","changedProps","_get","_getPrototypeOf","prototype","this","call","markdownWorker","_render","_callee","walker","node","regeneratorRuntime","wrap","_context","prev","next","renderMarkdown","content","breaks","gfm","tables","allowSvg","innerHTML","sent","_resize","createTreeWalker","nextNode","currentNode","HTMLAnchorElement","host","location","target","rel","addEventListener","stop","fireEvent","_this2","UpdatingElement","subscribeRenderTemplate","conn","onChange","subscribeMessage","msg","result","assign","HuiMarkdownCard","_decorate","_initialize","_LitElement","_LitElement2","_inherits","_super","_createSuper","_this","_classCallCheck","_len","arguments","length","args","Array","_key","apply","concat","_assertThisInitialized","F","kind","static","key","value","_getConfigElement","_asyncToGenerator","mark","all","then","bind","abrupt","createElement","decorators","undefined","_config","card_size","split","title","config","_disconnect","_hass","_connect","hass","html","_templateObject2","classMap","no-header","_content","_templateObject","oldHass","get","oldConfig","themes","theme","applyThemesOnElement","_connect2","_callee2","_this3","_context2","_unsubRenderTemplate","connection","template","entity_ids","entity_id","variables","user","_disconnect2","_callee3","unsub","_context3","t0","code","css","_templateObject3","LitElement"],"mappings":"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","file":"chunk.4a1690106369e7414c0b.js","sourcesContent":["\n\t\t\t\tvar addMethods = require(\"../../node_modules/workerize-loader/dist/rpc-wrapper.js\")\n\t\t\t\tvar methods = [\"renderMarkdown\"]\n\t\t\t\tmodule.exports = function() {\n\t\t\t\t\tvar w = new Worker(__webpack_public_path__ + \"3c481c237c92772bbc63.worker.js\", { name: \"[hash].worker.js\" })\n\t\t\t\t\taddMethods(w, methods)\n\t\t\t\t\t\n\t\t\t\t\treturn w\n\t\t\t\t}\n\t\t\t","export default function addMethods(worker, methods) {\n\tlet c = 0;\n\tlet callbacks = {};\n\tworker.addEventListener('message', (e) => {\n\t\tlet d = e.data;\n\t\tif (d.type!=='RPC') return;\n\t\tif (d.id) {\n\t\t\tlet f = callbacks[d.id];\n\t\t\tif (f) {\n\t\t\t\tdelete callbacks[d.id];\n\t\t\t\tif (d.error) {\n\t\t\t\t\tf[1](Object.assign(Error(d.error.message), d.error));\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tf[0](d.result);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlet evt = document.createEvent('Event');\n\t\t\tevt.initEvent(d.method, false, false);\n\t\t\tevt.data = d.params;\n\t\t\tworker.dispatchEvent(evt);\n\t\t}\n\t});\n\tmethods.forEach( method => {\n\t\tworker[method] = (...params) => new Promise( (a, b) => {\n\t\t\tlet id = ++c;\n\t\t\tcallbacks[id] = [a, b];\n\t\t\tworker.postMessage({ type: 'RPC', id, method, params });\n\t\t});\n\t});\n}\n","import { customElement, property, UpdatingElement } from \"lit-element\";\n// @ts-ignore\n// eslint-disable-next-line import/no-webpack-loader-syntax\nimport markdownWorker from \"workerize-loader!../resources/markdown_worker\";\nimport { fireEvent } from \"../common/dom/fire_event\";\n\nlet worker: any | undefined;\n\n@customElement(\"ha-markdown\")\nclass HaMarkdown extends UpdatingElement {\n  @property() public content = \"\";\n\n  @property({ type: Boolean }) public allowSvg = false;\n\n  @property({ type: Boolean }) public breaks = false;\n\n  protected update(changedProps) {\n    super.update(changedProps);\n\n    if (!worker) {\n      worker = markdownWorker();\n    }\n\n    this._render();\n  }\n\n  private async _render() {\n    this.innerHTML = await worker.renderMarkdown(\n      this.content,\n      {\n        breaks: this.breaks,\n        gfm: true,\n        tables: true,\n      },\n      {\n        allowSvg: this.allowSvg,\n      }\n    );\n\n    this._resize();\n\n    const walker = document.createTreeWalker(\n      this,\n      1 /* SHOW_ELEMENT */,\n      null,\n      false\n    );\n\n    while (walker.nextNode()) {\n      const node = walker.currentNode;\n\n      // Open external links in a new window\n      if (\n        node instanceof HTMLAnchorElement &&\n        node.host !== document.location.host\n      ) {\n        node.target = \"_blank\";\n        node.rel = \"noreferrer\";\n\n        // protect referrer on external links and deny window.opener access for security reasons\n        // (see https://mathiasbynens.github.io/rel-noopener/)\n        node.rel = \"noreferrer noopener\";\n\n        // Fire a resize event when images loaded to notify content resized\n      } else if (node) {\n        node.addEventListener(\"load\", this._resize);\n      }\n    }\n  }\n\n  private _resize = () => fireEvent(this, \"iron-resize\");\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-markdown\": HaMarkdown;\n  }\n}\n","import { Connection, UnsubscribeFunc } from \"home-assistant-js-websocket\";\n\ninterface RenderTemplateResult {\n  result: string;\n}\n\nexport const subscribeRenderTemplate = (\n  conn: Connection,\n  onChange: (result: string) => void,\n  params: {\n    template: string;\n    entity_ids?: string | string[];\n    variables?: object;\n  }\n): Promise<UnsubscribeFunc> => {\n  return conn.subscribeMessage(\n    (msg: RenderTemplateResult) => onChange(msg.result),\n    { type: \"render_template\", ...params }\n  );\n};\n","import { UnsubscribeFunc } from \"home-assistant-js-websocket\";\nimport {\n  css,\n  CSSResult,\n  customElement,\n  html,\n  LitElement,\n  property,\n  PropertyValues,\n  TemplateResult,\n} from \"lit-element\";\nimport { classMap } from \"lit-html/directives/class-map\";\nimport { applyThemesOnElement } from \"../../../common/dom/apply_themes_on_element\";\nimport \"../../../components/ha-card\";\nimport \"../../../components/ha-markdown\";\nimport { subscribeRenderTemplate } from \"../../../data/ws-templates\";\nimport { HomeAssistant } from \"../../../types\";\nimport { LovelaceCard, LovelaceCardEditor } from \"../types\";\nimport { MarkdownCardConfig } from \"./types\";\n\n@customElement(\"hui-markdown-card\")\nexport class HuiMarkdownCard extends LitElement implements LovelaceCard {\n  public static async getConfigElement(): Promise<LovelaceCardEditor> {\n    await import(\n      /* webpackChunkName: \"hui-markdown-card-editor\" */ \"../editor/config-elements/hui-markdown-card-editor\"\n    );\n    return document.createElement(\"hui-markdown-card-editor\");\n  }\n\n  public static getStubConfig(): MarkdownCardConfig {\n    return {\n      type: \"markdown\",\n      content:\n        \"The **Markdown** card allows you to write any text. You can style it **bold**, *italicized*, ~strikethrough~ etc. You can do images, links, and more.\\n\\nFor more information see the [Markdown Cheatsheet](https://commonmark.org/help).\",\n    };\n  }\n\n  @property() private _config?: MarkdownCardConfig;\n\n  @property() private _content?: string = \"\";\n\n  @property() private _unsubRenderTemplate?: Promise<UnsubscribeFunc>;\n\n  @property() private _hass?: HomeAssistant;\n\n  public getCardSize(): number {\n    return this._config === undefined\n      ? 3\n      : this._config.card_size === undefined\n      ? this._config.content.split(\"\\n\").length + (this._config.title ? 1 : 0)\n      : this._config.card_size;\n  }\n\n  public setConfig(config: MarkdownCardConfig): void {\n    if (!config.content) {\n      throw new Error(\"Invalid Configuration: Content Required\");\n    }\n\n    this._config = config;\n    this._disconnect().then(() => {\n      if (this._hass) {\n        this._connect();\n      }\n    });\n  }\n\n  public disconnectedCallback() {\n    this._disconnect();\n  }\n\n  public set hass(hass) {\n    this._hass = hass;\n    this._connect();\n  }\n\n  protected render(): TemplateResult {\n    if (!this._config) {\n      return html``;\n    }\n\n    return html`\n      <ha-card .header=\"${this._config.title}\">\n        <ha-markdown\n          breaks\n          class=\"markdown ${classMap({\n            \"no-header\": !this._config.title,\n          })}\"\n          .content=\"${this._content}\"\n        ></ha-markdown>\n      </ha-card>\n    `;\n  }\n\n  protected updated(changedProps: PropertyValues): void {\n    super.updated(changedProps);\n    if (!this._config || !this._hass) {\n      return;\n    }\n    const oldHass = changedProps.get(\"hass\") as HomeAssistant | undefined;\n    const oldConfig = changedProps.get(\"_config\") as\n      | MarkdownCardConfig\n      | undefined;\n\n    if (\n      !oldHass ||\n      !oldConfig ||\n      oldHass.themes !== this.hass.themes ||\n      oldConfig.theme !== this._config.theme\n    ) {\n      applyThemesOnElement(this, this._hass.themes, this._config.theme);\n    }\n  }\n\n  private async _connect() {\n    if (!this._unsubRenderTemplate && this._hass && this._config) {\n      this._unsubRenderTemplate = subscribeRenderTemplate(\n        this._hass.connection,\n        (result) => {\n          this._content = result;\n        },\n        {\n          template: this._config.content,\n          entity_ids: this._config.entity_id,\n          variables: {\n            config: this._config,\n            user: this._hass.user!.name,\n          },\n        }\n      );\n      this._unsubRenderTemplate.catch(() => {\n        this._content = this._config!.content;\n        this._unsubRenderTemplate = undefined;\n      });\n    }\n  }\n\n  private async _disconnect() {\n    if (this._unsubRenderTemplate) {\n      try {\n        const unsub = await this._unsubRenderTemplate;\n        this._unsubRenderTemplate = undefined;\n        await unsub();\n      } catch (e) {\n        if (e.code === \"not_found\") {\n          // If we get here, the connection was probably already closed. Ignore.\n        } else {\n          throw e;\n        }\n      }\n    }\n  }\n\n  static get styles(): CSSResult {\n    return css`\n      ha-markdown {\n        display: block;\n        padding: 0 16px 16px;\n        -ms-user-select: initial;\n        -webkit-user-select: initial;\n        -moz-user-select: initial;\n      }\n      .markdown.no-header {\n        padding-top: 16px;\n      }\n      ha-markdown > *:first-child {\n        margin-top: 0;\n      }\n      ha-markdown > *:last-child {\n        margin-bottom: 0;\n      }\n      ha-markdown a {\n        color: var(--primary-color);\n      }\n      ha-markdown img {\n        max-width: 100%;\n      }\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"hui-markdown-card\": HuiMarkdownCard;\n  }\n}\n"],"sourceRoot":""}